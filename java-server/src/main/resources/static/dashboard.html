<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Monitoring Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; background:#111; color:#fff }
    .topbar { display:flex; align-items:center; gap:12px; padding:12px; background:#0f1720 }
    .title { font-size:18px; font-weight:600 }
    .controls { margin-left:auto }
    .controls button { padding:8px 12px; margin-left:8px }
    .container { display:flex; height:calc(100% - 56px); }
    .left { flex:1; display:flex; align-items:center; justify-content:center; padding:12px }
    .left img { max-width:100%; max-height:100%; border:3px solid #222; background:#fff }
    .right { width:320px; overflow:auto; border-left:1px solid #222; background:#0b0f12; padding:12px }
    .thumb { margin-bottom:12px; cursor:pointer; }
    .thumb img { width:100%; height:80px; object-fit:cover; border:2px solid #222 }
    .info { font-size:12px; color:#ccc; margin-top:8px }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Monitoring Dashboard</div>
    <div class="controls">
      <button id="refreshBtn">Refresh Now</button>
      <button id="stopPollBtn">Stop Auto</button>
      <button id="startPollBtn" style="display:none">Start Auto</button>
      <a href="/" style="color:#9cc; text-decoration:none; margin-left:12px">Control</a>
    </div>
  </div>
  <div class="container">
    <div class="left">
      <img id="mainImage" src="" alt="No image yet">
    </div>
    <div class="right">
      <div style="font-weight:600; margin-bottom:8px">Recent Images</div>
      <div id="thumbList"></div>
      <div class="info">Images are loaded from the server's <code>experiment</code> folder. Use the Control page to start/stop the TCP server.</div>
    </div>
  </div>

  <script>
    const pollIntervalMs = 2000;
    let pollTimer = null;
    let currentImage = null;

    async function fetchImages(){
      try{
        const r = await fetch('/images');
        if(!r.ok) return [];
        return await r.json();
      }catch(e){ return []; }
    }

    async function updateOnce(){
      const list = await fetchImages();
      const thumbList = document.getElementById('thumbList');
      thumbList.innerHTML = '';
      if(!list || list.length===0){ document.getElementById('mainImage').src=''; return; }
      const newest = list[0];
      if(newest !== currentImage){
        currentImage = newest;
        document.getElementById('mainImage').src = '/images?name=' + encodeURIComponent(newest) + '&t=' + Date.now();
      }
      list.forEach(n => {
        const d = document.createElement('div'); d.className='thumb';
        const img = document.createElement('img');
        img.src = '/images?name=' + encodeURIComponent(n) + '&t=' + Date.now();
        img.alt = n;
        img.onclick = () => { currentImage = n; document.getElementById('mainImage').src = img.src; };
        d.appendChild(img);
        const cap = document.createElement('div'); cap.style.fontSize='12px'; cap.style.color='#ccc'; cap.style.marginTop='6px'; cap.textContent = n;
        d.appendChild(cap);
        thumbList.appendChild(d);
      });
    }

    function startPolling(){ if(pollTimer) return; pollTimer = setInterval(updateOnce, pollIntervalMs); updateOnce(); }
    function stopPolling(){ if(!pollTimer) return; clearInterval(pollTimer); pollTimer = null; }

    document.getElementById('refreshBtn').addEventListener('click', updateOnce);
    document.getElementById('stopPollBtn').addEventListener('click', ()=>{ stopPolling(); document.getElementById('stopPollBtn').style.display='none'; document.getElementById('startPollBtn').style.display='inline-block'; });
    document.getElementById('startPollBtn').addEventListener('click', ()=>{ startPolling(); document.getElementById('stopPollBtn').style.display='inline-block'; document.getElementById('startPollBtn').style.display='none'; });

    // start auto poll on load
    startPolling();
  </script>
</body>
</html>
